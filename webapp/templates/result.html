<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan Result</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* inline small progress bar tweaks (you can move into style.css) */
    .progress { width: 100%; background: #222; border-radius: 8px; height: 18px; overflow: hidden; margin-top: 10px; }
    .progress > .bar { height:100%; width:0%; background: linear-gradient(90deg,#238636,#58a6ff); transition: width .3s ease;}
    pre.log { background:#0b1116; padding:10px; color:#cbd5e1; height:200px; overflow:auto; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VulnScan â€” Scan Result</h1>
    <div id="info"></div>

    <div class="progress"><div class="bar" id="bar"></div></div>
    <p id="percent">Progress: 0%</p>

    <h3>Live Log</h3>
    <pre class="log" id="log">Waiting for server...</pre>

    <div id="links" style="margin-top:12px"></div>

    <p><a href="{{ url_for('index') }}">Start another scan</a></p>
  </div>

<script>
const scanId = "{{ scan_id }}";
const statusUrl = "{{ url_for('status', scan_id=scan_id) }}";

async function fetchStatus(){
  try{
    const resp = await fetch(statusUrl);
    if(!resp.ok) { console.error('status fetch failed', resp.status); return; }
    const data = await resp.json();
    const percent = data.progress || 0;
    document.getElementById('bar').style.width = percent + '%';
    document.getElementById('percent').innerText = 'Progress: ' + percent + '%';

    // update log
    const lg = document.getElementById('log');
    lg.innerText = (data.log || []).join("\\n");

    // when done, show links and stop polling
    if(data.done){
      const links = document.getElementById('links');
      if(data.html){
        const href = '/reports/' + data.html.split('/').pop();
        links.innerHTML = `<a class="button" href="${href}" target="_blank">Open HTML report</a>`;
      }
      if(data.json){
        const hrefj = '/reports/' + data.json.split('/').pop();
        links.innerHTML += ` <a class="button" href="${hrefj}" target="_blank">Open JSON</a>`;
      }
      if(data.error){
        links.innerHTML += `<p style="color:tomato">Error: ${data.error}</p>`;
      }
      // final fetch to ensure UI shows 100%
      document.getElementById('bar').style.width = '100%';
      document.getElementById('percent').innerText = 'Progress: 100%';
      clearInterval(poller);
    }
  }catch(err){
    console.error('status error', err);
  }
}

const poller = setInterval(fetchStatus, 1000);
fetchStatus(); // immediate
</script>
</body>
</html>
